<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Crypto Tweet Factory</title>
<style>
:root{
  --bg:#050708;--panel:#0b1115;--line:#13212c;
  --muted:#8aa1b1;--neon:#4ade80;--blue:#60aaff;
}
*{box-sizing:border-box}
body{
  margin:0;background:linear-gradient(180deg,#050708,#081019);
  color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  min-height:100vh;display:flex;align-items:center;justify-content:center;padding:22px;
}
.wrap{
  width:min(980px,96vw);
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
  border:1px solid var(--line);border-radius:16px;padding:18px;
  box-shadow:0 12px 36px rgba(0,0,0,.35);
}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
h1{margin:0;font-size:20px;color:var(--neon)}
.right{display:flex;gap:8px;align-items:center}
.addrBtn{
  background:#0f1a12;border:1px solid #1b3927;color:#bfffd3;
  border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;
}
.addrBtn:hover{filter:brightness(1.05)}
.tipBtn{
  background:var(--neon);color:#001c09;font-weight:800;border:none;border-radius:10px;
  padding:8px 14px;cursor:pointer;transition:transform .15s ease,opacity .15s ease;
}
.tipBtn:hover{transform:scale(1.05);opacity:.92}
.btn{border:none;border-radius:10px;padding:10px 16px;font-weight:800;cursor:pointer;font-size:15px}
.btn.gen{background:var(--neon);color:#001c09}
.btn.tweet{background:var(--blue);color:#001426}
.btn.copy,.btn.back,.btn.toggle{background:transparent;border:1px solid var(--line);color:#cfeaff}
#tweet-box{
  background:var(--panel);border:1px solid var(--line);
  border-radius:12px;padding:24px;margin:12px 0;text-align:center;
  font-size:18px;line-height:1.45;box-shadow:0 0 12px rgba(74,222,128,0.2);
  min-height:96px;display:flex;align-items:center;justify-content:center;
}
.actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
.countdown{margin-top:6px;text-align:center;color:#9ec1ff;font-size:13px;min-height:18px}
.topbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.input{flex:1 1 360px;background:#0d151c;color:#dfe8f4;border:1px solid #0f1820;
  padding:10px 12px;border-radius:12px;outline:none}
select{background:#0b141b;color:#dfe8f4;border:1px solid #13212c;
  padding:8px 10px;border-radius:10px;font-weight:700}
.toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  background:#0e1b13;border:1px solid #1b3927;padding:10px 20px;
  border-radius:12px;color:#9fffb9;font-weight:600;
  box-shadow:0 0 15px rgba(74,222,128,.3);opacity:0;
  transition:opacity .25s,transform .25s;z-index:9999;
}
.small{font-size:12px;color:#9ec1ff;margin-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Crypto Tweet Factory <span class="small" id="rpcLabel"></span></h1>
    <div class="right">
      <button id="addrBtn" class="addrBtn" title="Click to copy">77M7...mRjv</button>
      <button id="tipBtn" class="tipBtn">üí∞ Tip 0.1 SOL</button>
    </div>
  </header>

  <div class="topbar">
    <input id="search" class="input" placeholder="Type a keyword (e.g., PEPE, Solana, Elon)">
    <select id="tone">
      <option value="funny">Funny üòÜ</option>
      <option value="sarcastic">Sarcastic üòè</option>
      <option value="motivational">Motivational üí™</option>
    </select>
    <select id="length">
      <option value="short" selected>Short (‚â§150)</option>
      <option value="long">Long (200‚Äì250)</option>
    </select>
    <button id="searchGen" class="btn gen">Generate</button>
  </div>

  <div id="tweet-box">Loading tweet...</div>
  <div class="countdown" id="countdown"></div>

  <div class="actions">
    <button id="back" class="btn back">‚¨Ö Back</button>
    <button id="generate" class="btn gen">Generate</button>
    <button id="tweet" class="btn tweet">Tweet</button>
    <button id="copy" class="btn copy">Copy</button>
    <button id="auto" class="btn toggle">Auto Mode : OFF</button>
    <select id="speed">
      <option value="3000">3s</option>
      <option value="5000" selected>5s</option>
      <option value="10000">10s</option>
      <option value="15000">15s</option>
    </select>
  </div>
</div>

<!-- web3.js f√ºr Phantom -->
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>

<script>
// ===== Phantom Tip mit RPC-Rotation + v0/legacy Fallback, getrennte Copy-Adresse =====
const WALLET_SOL = "77M7waPc3o6uEpwHxnNRzJ9Ga47gnFPZVJKu3AP1mRjv";
const TIP_AMOUNT_SOL = 0.1;

// Mehrere √∂ffentliche RPCs (ohne API-Key)
const RPCS = [
  "https://rpc.ankr.com/solana",
  "https://solana-api.projectserum.com",
  "https://api.mainnet-beta.solana.com"
];

let phantomProvider = null;
let phantomConnected = false;
let phantomPubkey = null;
let currentRpc = null;

function showToast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  requestAnimationFrame(()=>{t.style.opacity='1';t.style.transform='translate(-50%,0)';});
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,6px)';},1800);
  setTimeout(()=>t.remove(),2200);
}

function setRpcLabel(txt){
  const el=document.getElementById('rpcLabel');
  el.textContent = txt ? `RPC: ${txt}` : "";
}

function getProvider(){
  const p = window.solana || (window.phantom && window.phantom.solana);
  return (p && p.isPhantom) ? p : null;
}

function wireProviderEvents(p){
  if(!p || p.__wired) return;
  p.on('connect', (pubkey)=>{ phantomConnected = true; phantomPubkey = pubkey; showToast('Phantom connected ‚úÖ'); });
  p.on('disconnect', ()=>{ phantomConnected = false; phantomPubkey = null; showToast('Phantom disconnected'); });
  p.__wired = true;
}

async function getConn(){
  for(const url of RPCS){
    try {
      const c = new solanaWeb3.Connection(url, "confirmed");
      await c.getEpochInfo();
      currentRpc = url;
      setRpcLabel(new URL(url).hostname);
      return c;
    } catch (e) {}
  }
  throw new Error("No RPC reachable");
}

async function ensureConnected(){
  phantomProvider = getProvider();
  if(!phantomProvider){
    showToast("Phantom not found ‚Äî install the extension.");
    window.open("https://phantom.app/", "_blank");
    throw new Error("No Phantom");
  }
  wireProviderEvents(phantomProvider);

  if(phantomProvider.isConnected || phantomConnected){
    phantomConnected = true;
    phantomPubkey = phantomProvider.publicKey || phantomPubkey;
    return phantomPubkey;
  }
  const res = await phantomProvider.connect({ onlyIfTrusted:false });
  phantomConnected = true;
  phantomPubkey = res?.publicKey || phantomProvider.publicKey;
  return phantomPubkey;
}

async function buildV0Transfer(fromPubkey, toPubkey, lamports, conn){
  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash('finalized');
  const ix = solanaWeb3.SystemProgram.transfer({ fromPubkey, toPubkey, lamports });
  const msgV0 = new solanaWeb3.TransactionMessage({
    payerKey: fromPubkey,
    recentBlockhash: blockhash,
    instructions: [ix],
  }).compileToV0Message();
  const tx = new solanaWeb3.VersionedTransaction(msgV0);
  return { tx, blockhash, lastValidBlockHeight };
}

async function buildLegacyTransfer(fromPubkey, toPubkey, lamports, conn){
  const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash('finalized');
  const tx = new solanaWeb3.Transaction({ feePayer: fromPubkey, recentBlockhash: blockhash })
    .add(solanaWeb3.SystemProgram.transfer({ fromPubkey, toPubkey, lamports }));
  return { tx, blockhash, lastValidBlockHeight };
}

async function sendTip(amountSol){
  let conn;
  try{
    conn = await getConn();
  }catch(e){
    showToast("All RPCs blocked ‚ùå ‚Äî opening wallet link");
    const url = `https://phantom.app/ul/transfer?recipient=${encodeURIComponent(WALLET_SOL)}&amount=${encodeURIComponent(amountSol)}&label=${encodeURIComponent("Crypto Tweet Factory")}&message=${encodeURIComponent("Thanks!")}`;
    window.open(url, "_blank");
    return;
  }

  const fromPubkey = phantomPubkey;
  const toPubkey   = new solanaWeb3.PublicKey(WALLET_SOL);
  const lamports   = Math.floor(amountSol * solanaWeb3.LAMPORTS_PER_SOL);

  let signature, meta;

  try{
    meta = await buildV0Transfer(fromPubkey, toPubkey, lamports, conn);
    if (phantomProvider.signAndSendTransaction) {
      const res = await phantomProvider.signAndSendTransaction(meta.tx);
      signature = res.signature || res;
    } else {
      const signed = await phantomProvider.signTransaction(meta.tx);
      signature = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false });
    }
  }catch(errV0){
    try{
      meta = await buildLegacyTransfer(fromPubkey, toPubkey, lamports, conn);
      if (phantomProvider.signAndSendTransaction) {
        const res = await phantomProvider.signAndSendTransaction(meta.tx);
        signature = res.signature || res;
      } else {
        const signed = await phantomProvider.signTransaction(meta.tx);
        signature = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:false });
      }
    }catch(errLegacy){
      const msg = (errLegacy && (errLegacy.message || errLegacy.toString())) || "Unknown";
      if(msg.includes("403") || msg.toLowerCase().includes("forbidden")){
        showToast("RPC 403 ‚Äî switching‚Ä¶");
        try{
          await getConn();
          return await sendTip(amountSol);
        }catch(e2){
          showToast("All RPCs refused ‚ùå ‚Äî opening wallet link");
          const url = `https://phantom.app/ul/transfer?recipient=${encodeURIComponent(WALLET_SOL)}&amount=${encodeURIComponent(amountSol)}&label=${encodeURIComponent("Crypto Tweet Factory")}&message=${encodeURIComponent("Thanks!")}`;
          window.open(url, "_blank");
          return;
        }
      }
      const code = (errLegacy && (errLegacy.code || errLegacy.error?.code));
      if(code === 4001) showToast('User rejected in wallet ‚ùå');
      else showToast(`Failed ‚ùå ${msg}`.slice(0,90));
      throw errLegacy;
    }
  }

  showToast("Submitted üü¢");
  try{
    await conn.confirmTransaction({ signature, blockhash: meta.blockhash, lastValidBlockHeight: meta.lastValidBlockHeight }, "confirmed");
  }catch{}
  setTimeout(()=> window.open(`https://solscan.io/tx/${signature}`, "_blank"), 400);
}

// ===== Header Controls =====
// Copy-Address (separat)
document.getElementById("addrBtn").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(WALLET_SOL); showToast("Address copied ‚úÖ"); }catch(e){ showToast("Copy failed ‚ùå"); }
});

// Tip-Button (kein Copy mehr, nur Connect ‚Üí Send)
document.getElementById("tipBtn").addEventListener("click", async ()=>{
  try{
    if(!phantomConnected || !phantomProvider?.isConnected){
      await ensureConnected();
      showToast("Connected ‚Äî click again to send 0.1 SOL");
      return;
    }
    await sendTip(TIP_AMOUNT_SOL);
  }catch(e){
    console.error(e);
  }
});

// ====== Tweet Generator ======
const intros=["Honestly","Some days","Not gonna lie","Lately","Tell me why","Apparently","It's wild that","Sometimes I feel like","Just realized","You ever notice"];
const subjects=["the market","crypto","this coin","my portfolio","the charts","everything on-chain","my trades","my patience","these bags","my screen time"];
const actions=["keeps testing me","just wants chaos","never lets me rest","makes zero sense","is playing games","won‚Äôt calm down","acts like it‚Äôs personal","keeps reminding me I know nothing","is allergic to stability","has its own mood swings"];
const reactions=["and yet here I am still watching.","but I‚Äôm still here pretending I understand.","and I can‚Äôt even be mad anymore.","and I swear it‚Äôs funny now.","but deep down I love the drama.","and I keep thinking I‚Äôve learned something.","so I‚Äôll just keep coping in HD.","while acting like it‚Äôs all part of my plan.","and I‚Äôm taking it personally.","but this is the life I chose."];
const addons=["Trying to stay calm but my coffee‚Äôs doing the heavy lifting.","At this point I‚Äôm trading emotions more than tokens.","Every dip feels like character development.","Still waiting for a green candle that respects me.","My phone battery fears price alerts now.","Maybe the real bull run was the coping we did along the way."];

function rnd(a){return a[Math.floor(Math.random()*a.length)]}
function clamp(s,m){return s.length>m?s.slice(0,m-1)+'‚Ä¶':s;}
function buildSentence(keyword,len){
  const kw=keyword.trim()?` ${keyword}`:"";
  if(len==="short"){
    return clamp(`${rnd(intros)} ${rnd(subjects)}${kw} ${rnd(actions)} ${rnd(reactions)}`,150);
  } else {
    return clamp(`${rnd(intros)} ${rnd(subjects)}${kw} ${rnd(actions)} ${rnd(reactions)} ${rnd(addons)}`,250);
  }
}

let history=[],current="",autoTimer=null,INTERVAL=5000,countTimer=null;
const tweetBox=document.getElementById("tweet-box"),searchEl=document.getElementById("search"),
lenEl=document.getElementById("length"),countdown=document.getElementById("countdown");
function generate(){
  if(current)history.push(current);
  current=buildSentence(searchEl.value,lenEl.value);
  tweetBox.textContent=current;resetCountdown();
}
function back(){if(!history.length)return;current=history.pop();tweetBox.textContent=current;resetCountdown();}
function setAuto(on){
  const autoBtn=document.getElementById("auto");
  if(on){if(autoTimer)return;autoTimer=setInterval(generate,INTERVAL);autoBtn.textContent="Auto Mode : ON";}
  else{clearInterval(autoTimer);autoTimer=null;autoBtn.textContent="Auto Mode : OFF";}
  resetCountdown();
}
function resetCountdown(){
  clearInterval(countTimer);
  if(!autoTimer){countdown.textContent="";return;}
  let sec=Math.ceil(INTERVAL/1000);
  countdown.textContent="Next tweet in: "+sec+" s";
  countTimer=setInterval(()=>{sec--;countdown.textContent="Next tweet in: "+sec+" s";if(sec<=0){clearInterval(countTimer);countdown.textContent="Generating‚Ä¶";}},1000);
}

document.getElementById("generate").onclick=generate;
document.getElementById("searchGen").onclick=generate;
document.getElementById("back").onclick=back;
document.getElementById("tweet").onclick=()=>window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(current),"_blank");
document.getElementById("copy").onclick=async()=>{await navigator.clipboard.writeText(current);showToast("Copied ‚úÖ")};
document.getElementById("auto").onclick=()=>setAuto(!autoTimer);
document.getElementById("speed").onchange=e=>{INTERVAL=parseInt(e.target.value)||5000;if(autoTimer){setAuto(false);setAuto(true);}};

generate();
</script>
</body>
</html>
