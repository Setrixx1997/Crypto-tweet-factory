<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Crypto Tweet Factory ‚Äî MERGED FINAL</title>
<style>
:root{
  --bg:#050a0f; --panel:#0b1115; --line:#13212c; --text:#e6eef8; --muted:#8aa1b1;
  --neon:#00ffae; --neon2:#00c8ff; --good:#77ffcc; --blue:#60aaff; --warn:#ffb86b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:
    radial-gradient(1100px 520px at 15% -10%, rgba(0,255,174,.09), transparent 70%),
    radial-gradient(900px 600px at 90% 0%, rgba(0,200,255,.07), transparent 70%),
    var(--bg);
  color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  display:flex; gap:16px;
}

/* Left rail */
.left-rail{ width:300px; min-width:280px; padding:14px; position:sticky; top:0; height:100dvh;
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
  border-right:1px solid var(--line); z-index:1; overflow:auto}
.card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.35); margin-bottom:12px}
.rank-title{display:flex;align-items:center;gap:10px;font-weight:800}
.rank-row{margin-top:8px;font-size:14px;color:var(--muted)}
.progress{margin-top:10px; background:#0d151c; border:1px solid #12222d; border-radius:999px; height:12px; overflow:hidden}
.progress > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--neon),var(--neon2)); box-shadow:0 0 16px rgba(0,255,174,.45)}

.small-actions{display:flex;gap:8px;margin-top:10px}
.btn.small{padding:6px 10px;border-radius:10px;font-size:12px}

/* Quests */
.quest{background:#0e151a;border:1px solid #17242f;border-radius:10px;padding:10px;margin:8px 0}
.quest .head{display:flex;justify-content:space-between;gap:8px;align-items:center}
.quest .name{font-weight:800}
.quest .reward{color:#bfeadf;font-size:12px}
.qbar{margin-top:8px;background:#0d151c;border:1px solid #12222d;border-radius:999px;height:10px;overflow:hidden}
.qbar > span{display:block;height:100%;width:0;background:linear-gradient(90deg,#77ffcc,#60aaff)}
.q-done{opacity:.85;border-color:#245336}
.q-countdown{margin-top:8px;font-size:12px;color:#9ec1ff;text-align:center}

/* Tokens */
.token-row{display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid var(--line);padding:8px 0}
.token-row:last-child{border-bottom:none}
.token-sym{font-weight:900;letter-spacing:.5px}
.token-chg.up{color:#77ffcc}
.token-chg.down{color:#ff9f9f}
.token-actions{display:flex;gap:6px}
.badge{display:inline-block;padding:2px 8px;border:1px solid #203140;border-radius:999px;color:#a8fbe2;font-size:11px;}

/* Main */
.main{flex:1; padding:16px 20px; max-width:1100px; margin:0 auto; position:relative; z-index:1;}
.topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.status-left{font-weight:800;color:#a8fbe2}
.toolbar-right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{
  background:#0e1a22; border:1px solid #203140; color:#cbecff;
  padding:9px 14px; border-radius:12px; font-weight:800; cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease, background .2s ease;
}
.btn:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,200,255,.18)}
.btn:active{transform:translateY(0)}
.btn.primary{background:linear-gradient(90deg,var(--neon),var(--neon2)); color:#002018; border:none}
.btn.blue{background:var(--blue); color:#001426; border:none}
.btn.ghost{background:transparent}
.glow-toggle{background:#0f1c22;border:1px solid #203140;color:#cbecff;position:relative}
.glow-toggle.active{
  border-color:#1e3b2a !important;
  box-shadow:0 0 0 2px rgba(0,255,174,.22) inset, 0 0 22px rgba(0,255,174,.5), 0 0 46px rgba(0,255,174,.32);
  background-image:radial-gradient(120% 120% at 50% -20%, rgba(0,255,174,.16), transparent 62%);
  animation:pulse 2.1s ease-in-out infinite;
}
@keyframes pulse{0%,100%{box-shadow:0 0 0 2px rgba(0,255,174,.2) inset, 0 0 18px rgba(0,255,174,.42), 0 0 36px rgba(0,255,174,.26)}50%{box-shadow:0 0 26px rgba(0,255,174,.62), 0 0 56px rgba(0,255,174,.4)}}
#hookToggle .flame{display:inline-block; transition: filter .2s ease, transform .2s ease; filter: drop-shadow(0 0 0 rgba(0,255,174,0)); margin-right:6px}
#hookToggle.active .flame{ filter: drop-shadow(0 0 8px rgba(0,255,174,.7)); animation: flameFlicker 900ms steps(2,end) infinite, flameDrift 1.3s ease-in-out infinite; }
@keyframes flameFlicker{0%{opacity:.92}50%{opacity:.76}100%{opacity:.92}}
@keyframes flameDrift{0%{transform:translate(0,0)}50%{transform:translate(.5px,-.6px)}100%{transform:translate(0,0)}}

.title{text-align:center; font-weight:900; letter-spacing:.6px; margin:6px 0 14px 0; text-shadow:0 0 18px rgba(0,255,174,.15), 0 0 24px rgba(0,200,255,.1);}

/* Tweet card */
.content-card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 14px 36px rgba(0,0,0,.35); max-width:820px; margin:0 auto;}
#tweet{background:#0d151c; border:1px solid #10202a; border-radius:12px; padding:18px; min-height:110px; font-size:20px; line-height:1.45; text-align:center;}
.controls{display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap}
.score-wrap{display:flex;align-items:center;justify-content:center; gap:10px; margin:16px 0 6px}
.score-bar{width:360px; height:12px; background:#0d151c; border:1px solid #12222d; border-radius:999px; overflow:hidden}
.score-bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff6b6b,#ffd36e,#77ffcc); box-shadow:0 0 14px rgba(0,255,174,.35)}
.score-val{font-weight:900; letter-spacing:.8px}
.sub-quote{text-align:center;color:#9ec1ff;font-size:12px;min-height:18px;margin-top:4px}

/* Auto */
.auto-wrap{display:flex; gap:8px; justify-content:center; align-items:center; margin:10px 0 4px}
.select{
  background:#0e1a22; color:#cbecff; border:1px solid #203140; border-radius:12px; padding:8px 10px;
  appearance:none;
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24'><path fill='%23182632' d='M7 10l5 5 5-5z'/></svg>");
  background-repeat:no-repeat; background-position:right 10px center; padding-right:34px;
}
.select:focus{outline:2px solid #1f3644}
.countdown{min-width:120px; text-align:center; color:#9ad7ff; font-size:13px}

/* Footer */
.footer{margin-top:18px; display:flex; align-items:center; justify-content:space-between; gap:10px; font-size:13px; color:#a9c7d4}
.copyAddr{color:var(--good); cursor:pointer}
.copyAddr:hover{text-decoration:underline}
.brand{opacity:.9}

/* Modals + Toast */
.modal-overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000;}
.modal{width:min(760px,92vw); background:var(--panel); border:1px solid var(--line); border-radius:14px; box-shadow:0 24px 80px rgba(0,0,0,.55)}
.modal header{display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--line)}
.modal .body{padding:14px}
.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:#0e1b13;border:1px solid #1b3927;padding:10px 20px;border-radius:12px;color:#9fffb9;font-weight:800;box-shadow:0 0 15px rgba(74,222,128,.3);opacity:0;transition:opacity .25s,transform .25s;z-index:2002}

/* Upgrade button (gold) */
.upgBtn{ 
  background: linear-gradient(90deg,#ffd465,#ffb52e);
  color:#3a2600; border:1px solid #7a5200; border-radius:12px;
  padding:9px 14px; font-weight:900; box-shadow:0 8px 22px rgba(255,191,71,.28), inset 0 0 0 1px rgba(255,255,255,.12);
}
.upgBtn:hover{ box-shadow:0 10px 28px rgba(255,191,71,.42); transform: translateY(-1px); }
.upgBtn:active{ transform: translateY(0); }

/* Premium badge */
.premBadge{background:#223a20;color:#bfffd3;border:1px solid #12321a;padding:6px 10px;border-radius:10px;font-weight:800;}
</style>
</head>
<body>

<!-- LEFT COLUMN -->
<aside class="left-rail">
  <div class="card" id="rankCard">
    <div class="rank-title"><span class="badge">üèÖ</span> <span><strong>Tweet Rank</strong></span></div>
    <div class="rank-row"><strong>Rank:</strong> <span id="rankName">Normie</span></div>
    <div class="rank-row"><strong>XP:</strong> <span id="xpVal">0</span> / <span id="xpNext">200</span></div>
    <div class="progress"><span id="xpBar"></span></div>
    <div class="rank-row"><strong>Streak:</strong> <span id="streakVal">0</span> days</div>
    <div class="small-actions">
      <button id="resetRank" class="btn small ghost" type="button">‚Ü∫ Reset Rank</button>
    </div>
  </div>

  <div class="card" id="questsCard">
    <div class="rank-title"><span class="badge">üìÖ</span> <span><strong>Daily Quests</strong></span></div>
    <div id="questsWrap"></div>
    <div class="q-countdown" id="questsCountdown">Resets in --:--:--</div>
  </div>

  <div class="card" id="memesCard">
    <div class="rank-title">
      <span class="badge">üöÄ</span> <span><strong>Realtime Meme Coins</strong></span>
      <span class="badge" id="autoTokensBadge" style="margin-left:auto;cursor:pointer" title="Auto rotate every 15s">Auto: OFF</span>
    </div>
    <div style="font-size:12px;color:#9ec1ff;margin:6px 0 8px 0">Local mock (no API). Click a coin to toggle in your tweet.</div>
    <div id="tokensWrap"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="refreshTokens" class="btn small" type="button">‚Üª Refresh</button>
      <button id="insertTopToken" class="btn small" type="button">‚ûï Add/Remove Top Coin</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="status-left">üèÜ Rank: <span id="rankNameTop">Normie</span> | XP: <span id="xpTop">0</span></div>
    <div class="toolbar-right">
      <button id="hookToggle" class="btn glow-toggle" type="button"><span class="flame">üî•</span> Hook Boost</button>
      <button id="analyzeBtn" class="btn" type="button">üîç Analyze</button>
      <button id="packsBtn" class="btn" type="button">üß† Smart Packs</button>
      <button id="themeBtn" class="btn" type="button">üåà Theme</button>
      <button id="soundBtn" class="btn" type="button">üîä Sounds On</button>
      <span id="premBadge" class="premBadge" style="display:none">‚≠ê Premium</span>
      <button id="openUpgrade" class="upgBtn" type="button">üíé Upgrade</button>
      <!-- Music button will be injected here -->
    </div>
  </div>

  <h2 class="title">‚ö° Crypto Tweet Factory ‚ö°</h2>

  <section class="content-card">
    <div id="tweet">Tap ‚ÄúGenerate Tweet‚Äù to get started</div>
    <div class="controls">
      <button id="genBtn" class="btn primary" type="button">üîÅ Generate Tweet</button>
      <button id="tweetBtn" class="btn blue" type="button">üì¢ Tweet Now</button>
      <button id="copyBtn" class="btn" type="button">üìã Copy</button>
    </div>

    <div class="score-wrap">
      <div class="score-bar"><span id="scoreFill"></span></div>
      <div class="score-val"><span id="scoreVal">0</span>üî• Viral Score</div>
    </div>
    <div class="sub-quote" id="subQuote"></div>

    <div class="auto-wrap">
      <button id="autoBtn" class="btn glow-toggle" type="button">Auto Mode : OFF</button>
      <select id="autoSpeed" class="select">
        <option value="3000">3s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
        <option value="15000">15s</option>
      </select>
      <div class="countdown" id="countdown"></div>
    </div>
  </section>

  <div class="footer">
    <div>Tip SOL : <span id="addrShort" class="copyAddr" title="Click to copy">77M...Rjv</span><span id="addrFull" style="display:none">77M7waPc3o6uEpwHxnNRzJ9Ga47gnFPZVJKu3AP1mRjv</span></div>
    <div class="brand">Created by <strong>@setrixx19</strong></div>
  </div>
</main>

<!-- Analyze Modal -->
<div id="overlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="anTitle">
    <header>
      <strong id="anTitle">Analyze Boost Insights</strong>
      <button id="closeModal" class="btn small" type="button">‚úñ Close</button>
    </header>
    <div class="body">
      <div id="analysisText" style="line-height:1.55"></div>
    </div>
  </div>
</div>

<!-- Upgrade Modal -->
<div id="upgradeOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="upgTitle">
    <header>
      <strong id="upgTitle">Upgrade to Premium</strong>
      <button id="upgClose" class="btn small" type="button">Close</button>
    </header>
    <div class="body">
      <div><strong>Premium unlocks:</strong></div>
      <ul style="margin:6px 0 0 18px;line-height:1.45">
        <li>Smart Tweet Packs (3 ideas per click)</li>
        <li>Analyze Boost: deeper tips</li>
        <li>Faster Auto Mode (1‚Äì2s)</li>
      </ul>
      <hr style="border:none;border-top:1px solid #3b2a10;margin:10px 0">
      <div style="margin:10px 0">Optional tip: send <strong>0.1 SOL</strong> and paste TXID to unlock locally.</div>
      <div style="font-family:monospace;color:#ffd465">77M7waPc3o6uEpwHxnNRzJ9Ga47gnFPZVJKu3AP1mRjv</div>
      <input id="upgTxid" placeholder="Paste TXID‚Ä¶" style="width:100%;padding:10px;border-radius:10px;border:1px solid #3b2a10;background:#0b0a06;color:#f6e2bb;margin:10px 0" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="upgMark" class="upgBtn" type="button">Mark as Paid</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const el = id => document.getElementById(id);
const LS = k => localStorage.getItem(k);
const setLS = (k,v)=>localStorage.setItem(k,v);
function toast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  requestAnimationFrame(()=>{t.style.opacity=1; t.style.transform='translate(-50%,0)';});
  setTimeout(()=>{t.style.opacity=0; t.style.transform='translate(-50%,6px)';},1400);
  setTimeout(()=>t.remove(),1800);
}

/* ---------- Sound (SFX) ---------- */
const AC = window.AudioContext || window.webkitAudioContext; let ctx;
function ensureCtx(){ if(!ctx){ try{ ctx=new AC(); }catch(e){ console.warn('AudioContext failed',e);} } return ctx; }
let sfxOn = (LS('ctf_sfx_on') ?? 'true') === 'true';
function playTone(freq, dur, type, gain){
  if(!sfxOn) return;
  try{ const ac=ensureCtx(); if(!ac) return; const t0=ac.currentTime; const o=ac.createOscillator(), g=ac.createGain();
    o.type=type; o.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(0,t0); o.connect(g); g.connect(ac.destination);
    g.gain.linearRampToValueAtTime(gain,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    o.start(t0); o.stop(t0+dur+0.03);
  }catch(e){ console.warn('playTone',e); }
}
function genSound(){ playTone(290,.16,'sawtooth',0.05); }
function tweetSound(){ playTone(980,.13,'triangle',0.045); }
function clickOn(){ playTone(880,.11,'square',0.035); }
function clickOff(){ playTone(520,.10,'square',0.035); }
function rankUpSound(){
  if(!sfxOn) return; try{ const ac=ensureCtx(); if(!ac) return; const t0=ac.currentTime; const notes=[660,880,990,1320];
  notes.forEach((f,i)=>{ const o=ac.createOscillator(), g=ac.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(f,t0+i*0.08);
    g.gain.setValueAtTime(0,t0+i*0.08); o.connect(g); g.connect(ac.destination);
    g.gain.linearRampToValueAtTime(0.06, t0+i*0.08+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+i*0.08+0.18);
    o.start(t0+i*0.08); o.stop(t0+i*0.08+0.22);
  }); }catch(e){ console.warn('rankUp',e); }
}

/* ---------- Rank & XP ---------- */
let hookOn=false, autoOn=false, autoTimer=null, countdownTimer=null, interval=5000;
let xp=+(LS('ctf_xp')||0), streak=+(LS('ctf_streak')||0), lastRankName=LS('ctf_last_rank')||"Normie";

const ranks=[
  {name:"Normie", xp:0},
  {name:"Trader", xp:200},
  {name:"Meme Thinker", xp:500},
  {name:"Meme Lord", xp:1000},
  {name:"Chain Prophet", xp:2000},
  {name:"Legendary", xp:4000}
];
function currentRank(){ let r=ranks[0], next=ranks[1]; for(let i=0;i<ranks.length;i++){ if(xp>=ranks[i].xp){ r=ranks[i]; next=ranks[i+1]||ranks[i]; } } return {r,next}; }
function updateRankUI(playReward=false){
  const {r,next}=currentRank();
  el('rankName').textContent=r.name; el('rankNameTop').textContent=r.name;
  el('xpVal').textContent=xp; el('xpTop').textContent=xp;
  el('xpNext').textContent=next.xp;
  const base=r.xp,goal=next.xp; const pct=Math.max(0,Math.min(100,Math.round(((xp-base)/(goal-base||1))*100)));
  el('xpBar').style.width=pct+'%';
  if (playReward && r.name !== lastRankName){ rankUpSound(); toast("Rank Up! üéâ "+r.name); }
  lastRankName=r.name; setLS('ctf_last_rank', lastRankName);
}
function saveProgress(){ setLS('ctf_xp',xp); setLS('ctf_streak',streak); }

/* ---------- Viral Score & Tweets ---------- */
function viralScore(text){
  let s=42; const t=(text||"").trim(); const len=t.length;
  if (len>=110 && len<=170) s+=14;
  else if (len>=80 && len<110) s+=8;
  else if (len>170 && len<=250) s+=6;
  else if (len<60) s-=16;
  else if (len>260) s-=14;
  s += (Math.random()*16-8);
  s=Math.max(0,Math.min(100,Math.round(s)));
  return s;
}
function updateScoreUI(v){
  el('scoreFill').style.width=v+'%'; el('scoreVal').textContent=v;
  const qLow=["Not bad ‚Äî sharpen the hook.","Try a bolder statement.","Cleaner punchline might help."];
  const qMid=["Solid ‚Äî a little nudge and it pops.","Nice! Maybe add a tiny twist.","Good rhythm. Keep it snappy."];
  const qHigh=["Spicy! Ship it.","This could slap on CT.","Vibes are viral. Send it."];
  el('subQuote').textContent= v>70 ? qHigh[Math.floor(Math.random()*qHigh.length)] : v>40 ? qMid[Math.floor(Math.random()*qMid.length)] : qLow[Math.floor(Math.random()*qLow.length)];
}

const intros=["Honestly","Some days","Tell me why","Apparently","It‚Äôs wild that","Not gonna lie","Low-key","Lately","Real talk","Confession:"];
const subjects=["crypto","this market","my portfolio","these charts","this coin","the timeline","my watchlist","the memecoins","the whales","the vibes"];
const actions=["keeps surprising me","just wants drama","refuses to be boring","makes me rethink everything","is doing the most","has me refreshing charts","is speedrunning emotions","never runs out of memes","is writing its own sitcom","feels like a prank"];
const reactions=["and I‚Äôm still here for it.","and somehow I‚Äôm invested emotionally.","and I pretend I had a plan.","and I guess this is character growth.","and it‚Äôs hilarious at this point.","and I‚Äôll probably do it again.","while acting cool about it.","and the popcorn is ready.","and I‚Äôm coping gracefully.","but I‚Äôm fine. Totally."];
const addons=["Coffee is now an asset class.","Every dip unlocks a new personality trait.","Green candles cure everything.","I‚Äôll delete this tweet if it ages badly.","If you see me buying, look away.","Charts are my cardio.","Someone take my phone away."];
function rnd(a){ return a[Math.floor(Math.random()*a.length)]; }
function buildTweet(lenPref){ if(!lenPref) lenPref=Math.random()<0.5?'short':'long'; let s=`${rnd(intros)} ${rnd(subjects)} ${rnd(actions)} ${rnd(reactions)}`; if (lenPref==='long') s+=" "+rnd(addons); return s.replace(/\s+/g,' ').trim(); }
function setTweet(text){ el('tweet').textContent=text; updateScoreUI(viralScore(text)); refreshTokenButtons(); }

/* ---------- Auto Mode ---------- */
function startAuto(){ if(autoOn) return; autoOn=true; el('autoBtn').textContent="Auto Mode : ON"; el('autoBtn').classList.add('active'); clickOn(); runAuto(); }
function stopAuto(){ autoOn=false; el('autoBtn').textContent="Auto Mode : OFF"; el('autoBtn').classList.remove('active'); clickOff(); clearInterval(autoTimer); autoTimer=null; clearInterval(countdownTimer); countdownTimer=null; el('countdown').textContent=""; }
function runAuto(){ const tick=()=>{ const t=buildTweet(); setTweet(t); genSound(); startCountdown(); }; tick(); clearInterval(autoTimer); autoTimer=setInterval(tick,interval); startCountdown(); }
function startCountdown(){ clearInterval(countdownTimer); let sec=Math.ceil(interval/1000); el('countdown').textContent="Next in: "+sec+"s"; countdownTimer=setInterval(()=>{ sec--; el('countdown').textContent="Next in: "+sec+"s"; if(sec<=0) clearInterval(countdownTimer); },1000); }

/* ---------- Analyze ---------- */
function openAnalyze(){
  const t=el('tweet').textContent.trim();
  const v=viralScore(t);
  const delta=(hookOn?"+ XP boost active":"Enable Hook Boost for +XP");
  el('analysisText').innerHTML =
    `<div style="font-size:15px;margin-bottom:8px"><strong>Viral Probability:</strong> ${v}%</div>
     <div style="margin-bottom:8px">"${t}"</div>
     <div style="margin-bottom:8px;color:#bfeadf">Boost Delta: ${delta}</div>`;
  el('overlay').style.display='flex';
}
function closeAnalyze(){ el('overlay').style.display='none'; }

/* ---------- Quests ---------- */
function millisToNextMidnight(){
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);
  return next - now;
}
const QUEST_KEY_PREFIX = "ctf_quests_";
function todayKey(){
  const d = new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');
  return QUEST_KEY_PREFIX+`${yyyy}-${mm}-${dd}`;
}
const questTemplates = [
  { id:"q_tweet3",   name:"Post 3 tweets",          target:3,   reward:50 },
  { id:"q_score70",  name:"Hit Viral Score ‚â• 70",   target:1,   reward:30 },
  { id:"q_hook180",  name:"Keep Hook Boost 3 min",  target:180, reward:40, seconds:true }
];
let quests = null; let questTimer=null, questsCountdownTimer=null;
function loadOrInitQuests(){
  const key=todayKey(); const raw=LS(key);
  if(raw){ try{ quests = JSON.parse(raw); }catch{ quests=null; } }
  if(!quests){
    quests = {};
    questTemplates.forEach(q=> quests[q.id] = { progress:0, done:false, reward:q.reward, target:q.target, seconds:!!q.seconds, name:q.name });
    setLS(key, JSON.stringify(quests));
  }
}
function saveQuests(){ setLS(todayKey(), JSON.stringify(quests)); }
function renderQuests(){
  const wrap=el('questsWrap'); if(!wrap) return;
  wrap.innerHTML="";
  questTemplates.forEach(qt=>{
    const q = quests[qt.id];
    const div=document.createElement('div'); div.className='quest'+(q.done?' q-done':''); 
    const head=document.createElement('div'); head.className='head';
    head.innerHTML = `<span class="name">${qt.name}</span><span class="reward">+${q.reward} XP</span>`;
    const bar=document.createElement('div'); bar.className='qbar';
    const span=document.createElement('span'); bar.appendChild(span);
    let pct = Math.min(100, Math.round((q.progress/qt.target)*100));
    span.style.width = pct+'%';
    const info=document.createElement('div');
    const unit = qt.seconds ? 's' : '';
    info.style.fontSize='12px'; info.style.color='#9ec1ff';
    info.textContent = `${Math.min(q.progress, qt.target)} / ${qt.target}${unit}` + (q.done ? ' ‚Äî Completed ‚úÖ' : '');
    div.appendChild(head); div.appendChild(bar); div.appendChild(info);
    wrap.appendChild(div);
  });
}
function startQuestCountdown(){
  function tick(){
    const ms = millisToNextMidnight();
    const h = String(Math.floor(ms/3600000)).padStart(2,'0');
    const m = String(Math.floor((ms%3600000)/60000)).padStart(2,'0');
    const s = String(Math.floor((ms%60000)/1000)).padStart(2,'0');
    el('questsCountdown').textContent = `Resets in ${h}:${m}:${s}`;
  }
  tick(); clearInterval(questsCountdownTimer); questsCountdownTimer=setInterval(tick,1000);
}
function progressQuest(id, amount){
  const q = quests[id]; if(!q || q.done) return;
  q.progress += amount;
  if(q.progress >= q.target){
    q.progress = q.target; q.done = true;
    xp += q.reward; saveProgress(); updateRankUI(true);
    toast(`Quest complete: +${q.reward} XP`);
  }
  saveQuests(); renderQuests();
}
function startHookQuestTimer(){ clearInterval(questTimer); questTimer=setInterval(()=>{ if(hookOn) progressQuest("q_hook180", 1); },1000); }

/* ---------- Meme Coins ---------- */
const MEME_COINS = ["$PEPE","$WIF","$BONK","$DOGE","$SHIB","$FLOKI","$GROK","$MOON","$POPCAT","$BODEN","$TRUMP","$ELON","$TOSHI"];
let autoToken=false, autoTokenTimer=null;
function randomChange(){ const v=(Math.random()*14).toFixed(2); return (Math.random()<0.5?'-':'+')+v+'%'; }
function pickCoins(n=5){ const shuffled=[...MEME_COINS].sort(()=>Math.random()-0.5); return shuffled.slice(0,n).map(sym=>({sym,chg:randomChange()})); }
function hasCoin(sym){ const t=el('tweet').textContent; const re=new RegExp('(^|\\s)\\'+sym.replace('$','\\$')+'(\\s|$)'); return re.test(t); }
function removeCoin(sym){ let t=el('tweet').textContent; const re=new RegExp('(\\s)?\\'+sym.replace('$','\\$')+'(\\b)','g'); t=t.replace(re,'').replace(/\s{2,}/g,' ').trim(); setTweet(t); }
function addCoin(sym){ let t=el('tweet').textContent.trim(); if(!hasCoin(sym)){ t=(t+' '+sym).replace(/\s{2,}/g,' ').trim(); setTweet(t);} }
function toggleCoin(sym, btn){ if(hasCoin(sym)){ removeCoin(sym); btn.textContent='‚ûï Insert'; } else { addCoin(sym); btn.textContent='‚ûñ Remove'; } }
function refreshTokenButtons(){ document.querySelectorAll('#tokensWrap .token-row').forEach(row=>{ const sym=row.querySelector('.token-sym').textContent.trim(); const btn=row.querySelector('button'); btn.textContent=hasCoin(sym)?'‚ûñ Remove':'‚ûï Insert'; }); }
function renderTokens(list){
  const wrap=el('tokensWrap'); wrap.innerHTML="";
  list.forEach(it=>{
    const row=document.createElement('div'); row.className='token-row';
    const left=document.createElement('div'); left.innerHTML=`<span class="token-sym">${it.sym}</span> <span class="badge">now</span>`;
    const ch=document.createElement('div'); ch.className='token-chg '+(it.chg.startsWith('+')?'up':'down'); ch.textContent=it.chg;
    const actions=document.createElement('div'); actions.className='token-actions';
    const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='‚ûï Insert'; btn.onclick=()=>toggleCoin(it.sym, btn);
    actions.appendChild(btn); row.appendChild(left); row.appendChild(ch); row.appendChild(actions); wrap.appendChild(row);
  }); refreshTokenButtons();
}
function toggleAutoTokens(){
  autoToken=!autoToken; el('autoTokensBadge').textContent="Auto: "+(autoToken?"ON":"OFF");
  if(autoToken){ const run=()=>renderTokens(pickCoins()); run(); clearInterval(autoTokenTimer); autoTokenTimer=setInterval(run,15000); }
  else{ clearInterval(autoTokenTimer); autoTokenTimer=null; }
}

/* ---------- Wire up ---------- */
document.addEventListener('DOMContentLoaded', function(){
  // Buttons core
  el('genBtn').addEventListener('click', ()=>{ setTweet(buildTweet()); genSound(); });
  el('tweetBtn').addEventListener('click', ()=>{
    tweetSound();
    window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(el('tweet').textContent.trim()), "_blank");
    const v = viralScore(el('tweet').textContent.trim());
    xp += (hookOn?20:10); saveProgress(); updateRankUI(true);
    progressQuest("q_tweet3", 1);
    if(v>=70) progressQuest("q_score70", 1);
  });
  el('copyBtn').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(el('tweet').textContent.trim()); toast("Copied ‚úÖ"); }catch(e){ toast("Copy failed"); } });

  // Toggles
  el('autoBtn').addEventListener('click', ()=>{ if(autoOn) { clickOff(); stopAuto(); } else { clickOn(); startAuto(); } });
  el('autoSpeed').addEventListener('change', (e)=>{ interval=parseInt(e.target.value,10)||5000; if(autoOn){ stopAuto(); startAuto(); } });
  el('hookToggle').addEventListener('click', (e)=>{ hookOn=!hookOn; e.currentTarget.classList.toggle('active', hookOn); if(hookOn) clickOn(); else clickOff(); });

  // Analyze
  el('analyzeBtn').addEventListener('click', openAnalyze);
  el('closeModal').addEventListener('click', closeAnalyze);
  el('overlay').addEventListener('click', (ev)=>{ if(ev.target===el('overlay')) closeAnalyze(); });

  // SFX toggle
  const soundBtn = el('soundBtn');
  function updateSfxLabel(){ soundBtn.textContent = sfxOn ? "üîä Sounds On" : "üîá Sounds Muted"; }
  updateSfxLabel();
  soundBtn.addEventListener('click', ()=>{ sfxOn=!sfxOn; setLS('ctf_sfx_on', String(sfxOn)); updateSfxLabel(); });

  // Tip copy
  el('addrShort').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(el('addrFull').textContent.trim()); toast("SOL address copied ‚úÖ"); }catch(e){} });

  // Rank reset
  el('resetRank').addEventListener('click', ()=>{
    if(!confirm("Reset your rank and XP?")) return;
    xp=0; streak=0; lastRankName="Normie"; setLS('ctf_last_rank','Normie'); saveProgress(); updateRankUI(false); toast("Rank reset ‚úÖ");
  });

  // Quests
  loadOrInitQuests(); renderQuests(); startQuestCountdown(); startHookQuestTimer();

  // Tokens
  renderTokens(pickCoins());
  el('refreshTokens').addEventListener('click', ()=>renderTokens(pickCoins()));
  el('insertTopToken').addEventListener('click', ()=>{
    const symEl = el('tokensWrap').querySelector('.token-row .token-sym'); if(!symEl) return;
    const sym = symEl.textContent.trim(); if(hasCoin(sym)) removeCoin(sym); else addCoin(sym); refreshTokenButtons();
  });
  el('autoTokensBadge').addEventListener('click', toggleAutoTokens);

  // Upgrade overlay
  const upg = el('upgradeOverlay');
  el('openUpgrade').addEventListener('click', ()=>{ upg.style.display='flex'; });
  el('upgClose').addEventListener('click', ()=>{ upg.style.display='none'; });
  el('upgMark').addEventListener('click', ()=>{
    const tx=(el('upgTxid').value||'').trim(); if(!tx){ alert('Please paste a TXID.'); return; }
    localStorage.setItem('ctf_premium_v1','true'); el('premBadge').style.display='inline-block'; upg.style.display='none'; toast("Premium unlocked locally ‚úÖ");
  });

  // Init tweet + UI
  setTweet(buildTweet());
  updateRankUI(false);
});
</script>

<!-- === MUSIC v4 (toolbar button, docked, minimizable, with your playlists) === -->
<style>
  .ctfM4-btn{background:#0e1a22;border:1px solid #203140;color:#cbecff;padding:9px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .ctfM4-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,200,255,.18)}
  .ctfM4-panel{position:fixed;right:16px;bottom:12px;z-index:99998;width:min(420px,96vw);
    background:#0b1115;border:1px solid #13212c;border-radius:14px;box-shadow:0 24px 80px rgba(0,0,0,.55);color:#e6eef8;display:none}
  .ctfM4-panel header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #13212c}
  .ctfM4-body{padding:10px 12px;display:grid;gap:10px}
  .ctfM4-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctfM4-sel{background:#0e1a22;color:#cbecff;border:1px solid #203140;border-radius:12px;padding:8px 10px}
  .ctfM4-ctl{background:#0e1a22;border:1px solid #203140;color:#cbecff;padding:6px 10px;border-radius:10px;cursor:pointer}
  .ctfM4-iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:10px;overflow:hidden}
  .ctfM4-panel.mini .ctfM4-body{height:0;padding:0;overflow:hidden}
  .ctfM4-miniBar{display:none;align-items:center;gap:8px;padding:8px 12px}
  .ctfM4-panel.mini .ctfM4-miniBar{display:flex}
  .ctfM4-pill{background:#0e1a22;border:1px solid #203140;color:#cbecff;border-radius:999px;padding:4px 10px;font-size:12px}
</style>
<div id="ctfM4-root"></div>
<script>
(function(){
  const rootId='ctfM4-root'; if(document.getElementById(rootId)?.dataset.init==='1') return;
  const root=document.getElementById(rootId)||document.body.appendChild(Object.assign(document.createElement('div'),{id:rootId}));
  root.dataset.init='1';
  const LINKS={
    lofi:      "https://www.youtube.com/embed?listType=playlist&list=RDCLAK5uy_kb7EBi6y3GrtJri4_ZH56Ms786DFEimbM&autoplay=0&mute=0&playsinline=1&rel=0&controls=1&modestbranding=1",
    synthwave: "https://www.youtube.com/embed?listType=playlist&list=PLaaoUDTfq6i89CpSFrNA59p_3GtThcc_q&autoplay=0&mute=0&playsinline=1&rel=0&controls=1&modestbranding=1",
    chilltrap: "https://www.youtube.com/embed?listType=playlist&list=PLWJhJqb697j7Uu8b52-2OHc4A3jMyu6sF&autoplay=1&mute=0&playsinline=1&rel=0&controls=1&modestbranding=1",
    ambient:   "https://www.youtube.com/embed?listType=playlist&list=PL_gP0VBdLBbZjqz4mNWDEq02G3sgRFrdD&v=nc91s-8aaBM&index=1&autoplay=0&mute=0&playsinline=1&rel=0&controls=1&modestbranding=1"
  };
  // Add button into toolbar
  const bar = document.querySelector('.toolbar-right') || document.querySelector('header .right') || document.body;
  const btn = Object.assign(document.createElement('button'),{id:'ctfM4-btn',className:'ctfM4-btn',textContent:'üéµ Music'});
  bar.appendChild(btn);
  // Panel
  const panel = Object.assign(document.createElement('div'),{id:'ctfM4-panel',className:'ctfM4-panel',ariaHidden:'true'});
  panel.innerHTML=`
    <header>
      <strong>Background Music</strong>
      <div style="display:flex;gap:6px;align-items:center">
        <span id="ctfM4-now" class="ctfM4-pill">‚Äî</span>
        <button id="ctfM4-min" class="ctfM4-ctl">‚Äì</button>
        <button id="ctfM4-close" class="ctfM4-ctl">‚úñ</button>
      </div>
    </header>
    <div class="ctfM4-miniBar">
      <span id="ctfM4-miniText">Chill Trap playing‚Ä¶</span>
      <button id="ctfM4-restore" class="ctfM4-ctl">‚ñ£</button>
    </div>
    <div class="ctfM4-body">
      <div class="ctfM4-row">
        <label>Style</label>
        <select id="ctfM4-style" class="ctfM4-sel">
          <option value="lofi">Lo-Fi</option>
          <option value="synthwave">Synthwave</option>
          <option value="chilltrap">Chill-Trap</option>
          <option value="ambient">Ambient</option>
        </select>
        <small style="color:#9ec1ff">If audio is blocked, press ‚ñ∂ in the player once.</small>
      </div>
      <iframe id="ctfM4-frame" class="ctfM4-iframe" allow="autoplay; encrypted-media" referrerpolicy="strict-origin-when-cross-origin"></iframe>
    </div>`;
  document.body.appendChild(panel);

  const styleSel=document.getElementById('ctfM4-style');
  const frame=document.getElementById('ctfM4-frame');
  const bClose=document.getElementById('ctfM4-close');
  const bMin=document.getElementById('ctfM4-min');
  const bRestore=document.getElementById('ctfM4-restore');
  const nowPill=document.getElementById('ctfM4-now');
  const miniText=document.getElementById('ctfM4-miniText');

  const LSStyle='ctfM4_style', LSMini='ctfM4_mini', LSOpened='ctfM4_opened_once';
  function open(){ panel.style.display='block'; }
  function close(){ panel.style.display='none'; }
  function setNowLabel(s){
    const map={lofi:'Lo-Fi', synthwave:'Synthwave', chilltrap:'Chill Trap', ambient:'Ambient'};
    nowPill.textContent = map[s] || s;
    miniText.textContent = (map[s]||s) + " playing‚Ä¶";
  }
  function minimize(){
    if(panel.classList.contains('mini')) return;
    frame.dataset.prev = frame.getAttribute('style')||'';
    frame.style.position='fixed'; frame.style.left='-9999px'; frame.style.top='-9999px';
    frame.style.width='1px'; frame.style.height='1px'; frame.style.pointerEvents='none';
    panel.classList.add('mini'); localStorage.setItem(LSMini,'1');
  }
  function restore(){
    if(!panel.classList.contains('mini')) return;
    frame.setAttribute('style', frame.dataset.prev||'');
    panel.classList.remove('mini'); localStorage.setItem(LSMini,'0');
  }
  function toggleMini(){ panel.classList.contains('mini')?restore():minimize(); }
  function loadStyle(s){ frame.src = LINKS[s] || LINKS.lofi; localStorage.setItem(LSStyle, s); setNowLabel(s); }

  const firstOpenDone = localStorage.getItem(LSOpened)==='1';
  const savedStyle = localStorage.getItem(LSStyle) || 'chilltrap';
  styleSel.value = firstOpenDone ? savedStyle : 'chilltrap';
  loadStyle(styleSel.value);
  if(!firstOpenDone){ open(); localStorage.setItem(LSOpened,'1'); }
  if(localStorage.getItem(LSMini)==='1'){ open(); minimize(); }

  btn.addEventListener('click', ()=> panel.style.display = (panel.style.display==='block'?'none':'block'));
  bClose.addEventListener('click', close);
  bMin.addEventListener('click', toggleMini);
  bRestore.addEventListener('click', restore);
  panel.querySelector('header').addEventListener('dblclick', toggleMini);
  styleSel.addEventListener('change', e=> loadStyle(e.target.value));
})();
</script>
<!-- === /MUSIC v4 === -->

</body>
</html>
